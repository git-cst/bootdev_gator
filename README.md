# Gator

A RSS feed aggregator service built in Go using Postgres as the database.  
  
## Table of Contents
- [Overview](#overview)
- [Features](#features)
- [Project Structure](#project-structure)
- [Installation](#installation)
- [Usage](#usage)
- [Requirements](#requirements)
- [Contributing](#contributing)

##  Change log
| Version | Changes | Date |
|------------|------------|------------|
| v1.0.0 | Make functional setup | 28/03-2024 |

## Overview
A CLI based RSS feed aggregator with local storage using a Postgres Database.

## Features
- Register rss feeds to aggregate
   - Store feeds for later consumption
   - Browse feeds 
- Register users
   - Users can follow feeds
   - Users can see what other people follow

## Project Structure
```
gator/
├── internal/
│   ├── commands/│
|   │   └── handlers/ 
|   |   |   ├── feeds.go                     # Feed related handlers
|   |   |   ├── helpers.go                   # Helper functions for handlers
|   |   |   ├── posts.go                     # Post related handlers
|   |   |   ├── service.go                   # Service related handlers
|   |   |   └── users.go                     # User related handlers       
│   │   └── command.go                       # Command struct, register, run and list commands
│   ├── config/               
|   |   ├── client.go                        # HTTP client setup for config struct
|   |   ├── config.go                        # Config struct and related functions
|   |   ├── logger.go                        # Log struct and logging functions
|   |   └── state.go                         # State struct    
│   ├── database/                      
|   |   ├── db.go                            # Generated by sqlc: database interface
|   |   ├── feed.sql.go                      # Generated by sqlc: go code to handle feed related queries
|   |   ├── models.go                        # Generated by sqlc: structs to interact with database schema
|   |   ├── posts.sql.go                     # Generated by sqlc: go code to handle post related queries
|   |   └── users.sql.go                     # Generated by sqlc: go code to handle user related queries        
│   ├── middleware/              
|   |   └── auth.go                          # Middelware returning database user struct
│   └── sql/
│       ├── migrations/
|       |   ├── 001_users.sql                # Goose up down migration to create and drop user table
|       |   ├── 002_feed.sql                 # Goose up down migration to create and drop feed table
|       |   ├── 003_feed_follows.sql         # Goose up down migration to create and drop feed_follows table
|       |   ├── 004_feed_add_columns.sql     # Goose up down migration to add column to feed table
|       |   └── 005_posts.sql                # Goose up down migration to create and drop posts table
│       ├── queries/                
|       |   ├── feeds.sql                    # SQL queries related to feed and feed_follows tables
|       |   ├── posts.sql                    # SQL queries related to posts table
|       |   └── users.sql                    # SQL queries related to users table
│       └── schema/
|           ├── feed.sql                     # Schema for feed table
|           ├── feeds_follows.sql            # Schema for feeds_follows table
|           ├── posts.sql                    # Schema for posts tabel
|           └── users.sql                    # Schema for users table
├── sqlc.yaml                                # Configuration for sqlc tool
└── main.go                                  # Application entry point
```

## Installation
**1. Clone the repository**
   ```
   git clone <repository-url>
   cd gator
   ```

**2. Install required dependencies**

   **Golang**
   
   If you don't already have golang installed here's the commands:  
   
   *Mac*  
   ```
   brew install go
   ```
   
   *Linux*  
   ```
   sudo apt update
   sudo apt install golang
   ```
   
   Verify the installation was a success using `go version`
   
   **Postgres**
   
   Install the database:
   
   *Mac*
   ```
   brew install postgresql@15
   ```
   
   *Linux*
   ```
   sudo apt update
   sudo apt install postgresql postgresql-contrib
   ```
   
   After installing ensure you are on the right psql version (should be 15+):  
   ```
   psql --version
   ```
   
   If you are installing on Linux ensure that you update the root password:
   ```
   sudo passwd postgres
   ```
   Enter a password, and be sure you won't forget it.
   
   We also need a [Postgres driver](https://github.com/lib/pq) to interact with the database.  
   ```
   go get github.com/lib/pq
   ```
   
   **Goose**
   
   We're using [Goose](https://github.com/pressly/goose#install) to handle the database migrations in the Postgres database.
   Install method:
   ```
   go install github.com/pressly/goose/v3/cmd/goose@latest
   ```
   
   Verify the installation was a success using `goose -version`.
   
   **SQLC**  
   
   We're using [SQLC](https://sqlc.dev/) to handle converting our SQL commands to type safe Go code.  
   Install method:  
   ```
   go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
   ```
   
   Verify the installation was a success using `sqlc version`.
  
**3. Create the config file**

We're currently using a JSON file to handle the current user on the machine.  
This may be updated later to be handled differently.  
  
Setup your file (named .gatorconfig.json) at your home directory.  
```json
{
  "db_url": "connection_string_goes_here",
  "current_user_name": "username_goes_here"
}
```
Replace the connection_string_goes_here with your connection string. See: [Goose migrations](#run-the-migrations).
The username replacement is handled by the application.

Here's a bash script that creates and fills the file.
```bash
cat > ~/gator_config.json << 'EOF'
{
  "db_url": "connection_string_goes_here",
  "current_user_name": "username_goes_here"
}
EOF
```

**4. Create your database**

Start the database service:
```
Mac: brew services start postgresql@15
Linux: sudo service postgresql start
```
  
Using either base psql or [PGAdmin](https://www.pgadmin.org/) connect to the server.  
For psql:  
```
Mac: psql postgres
Linux: sudo -u postgres psql
```
Create the database  
```
CREATE DATABASE gator;
```
Set the user password (Linux only).
  
**5. Run the migrations**  

We need to run the migrations like so:  
```
goose `connection string` up
```
  
Your connection string should be formatted like so:  
```
macOS (no password, your username): postgres://{user}:@localhost:5432/gator?sslmode=disable  
Linux (password from [section 4](#create-your-database), postgres user): postgres://{password}:postgres@localhost:5432/gator?sslmode=disable
```
  
Run all 5 migrations.  
You should see a confirmation message be printed to your terminal for each migration.  
  
**6. Install the application**

Go to your directory storing the go code and run:
```
go install .
```
  
## Usage
After installing there are a number of commands that can be used to interact with the application.  
I would recommend firstly using the help command:
```
[name of repository you installed in] help
```
For example I called mine gator so it would be `gator help`.  
  
The commands you should see alongside a description are:  
- help
   
*Users*  
- login  
- register 
- reset  
- users
  
*feeds/posts*    
- addfeed  
- browse   
- feeds    
- follow   
- following
- unfollow
   
*service*
- agg       
  
The following commands expect an argument to be passed as arguments:  
**`agg`** requires a time string to be passed (1m, 1h, 1d, etc.), this is the interval which the aggregator will use to scrape the feeds (**do not DoS the feeds**).  
**`addfeed`** requires the title of the feed and the url.  
**`browse`** defaults to showing the 2 most recent rss feed items, but you can pass a integer value and it will return that many rss feed items.  
**`login`** requires the name of the user logging in.  
**`register`** requires the name of the user to register in the postgres database.  
**`follow`** requires the title of the feed to follow.  
**`following`** by default returns what you are following, but you can pass another user name to see what they are following.  
**`unfollow`** requires the title of the feed that you want to unfollow.  

## Requirements
The application has the following dependencies:  
- Go  
- Postgres database  
- Postgres driver  
- Goose  
- SQLC  
  
## Contributing
1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for your changes
5. Run the existing tests to ensure nothing is broken
6. Submit a pull request